<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>City of Margate â€” Weather Operations Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   MARGATE BRAND VARIABLES
   Primary navy:  #003087
   Gold accent:   #C8973A
   Light gold:    #E8B84B
   Sky blue:      #0066CC
   Dark bg:       #001A4D
   Panel bg:      #002060
   Border:        #0A3A7A
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
:root {
  --navy:       #003087;
  --navy-dark:  #001A4D;
  --navy-mid:   #002060;
  --navy-light: #0A3A7A;
  --sky:        #0066CC;
  --gold:       #C8973A;
  --gold-light: #E8B84B;
  --gold-pale:  #F5D98A;
  --white:      #FFFFFF;
  --off-white:  #E8EEF8;
  --muted:      #7A9AC0;
  --border:     #0A3A7A;
  --panel:      rgba(0,32,96,0.85);

  --warning:    #E01010;
  --warning-bg: rgba(224,16,16,0.15);
  --watch:      #D4A017;
  --watch-bg:   rgba(212,160,23,0.15);
  --advisory:   #2288DD;
  --advisory-bg:rgba(34,136,221,0.15);
  --statement:  #22AA55;
  --statement-bg:rgba(34,170,85,0.12);
  --special:    #FF7A00;
  --special-bg: rgba(255,122,0,0.12);
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%;
  background: var(--navy-dark);
  color: var(--off-white);
  font-family: 'Source Sans 3', sans-serif;
  overflow: hidden;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   HEADER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#header {
  height: 56px;
  background: linear-gradient(135deg, #001A4D 0%, #003087 50%, #002060 100%);
  border-bottom: 3px solid var(--gold);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  position: relative;
  flex-shrink: 0;
  box-shadow: 0 2px 20px rgba(0,0,0,0.5);
}


.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.city-name-block { line-height: 1; }
.city-name-block .city-label {
  font-family: 'Oswald', sans-serif;
  font-size: 10px; font-weight: 400;
  letter-spacing: 4px; text-transform: uppercase;
  color: var(--gold-light); opacity: .8;
}
.city-name-block .city-name {
  font-family: 'Oswald', sans-serif;
  font-size: 22px; font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--white);
  line-height: 1;
}
.city-name-block .city-sub {
  font-family: 'Oswald', sans-serif;
  font-size: 11px; font-weight: 400;
  letter-spacing: 3px; text-transform: uppercase;
  color: var(--gold);
}

.header-center {
  position: absolute;
  left: 50%; transform: translateX(-50%);
  text-align: center;
}
.header-center .dash-title {
  font-family: 'Oswald', sans-serif;
  font-size: 14px; font-weight: 600;
  letter-spacing: 4px; text-transform: uppercase;
  color: var(--gold-light);
}
.header-center .zone-tag {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px; color: var(--muted);
  letter-spacing: 1px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.clock-block { text-align: right; }
.clock-time {
  font-family: 'Share Tech Mono', monospace;
  font-size: 22px; color: var(--white); letter-spacing: 2px;
}
.clock-date {
  font-family: 'Oswald', sans-serif;
  font-size: 11px; font-weight: 400;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted);
}

.status-pip {
  width: 9px; height: 9px; border-radius: 50%;
  background: #33DD66;
  box-shadow: 0 0 8px #33DD66;
  animation: pipPulse 2.5s infinite;
}
.status-pip.loading { background: var(--gold); box-shadow: 0 0 8px var(--gold); animation: pipPulse .8s infinite; }
.status-pip.error   { background: var(--warning); box-shadow: 0 0 8px var(--warning); animation: none; }
@keyframes pipPulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   MAIN GRID LAYOUT
   Top row: Radar (60%) | Right col (40%)
     Right col: Forecast (top) | Obs (bottom)
   Bottom row: Alerts table (100%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#dashboard {
  display: grid;
  grid-template-rows: 1fr auto;
  height: calc(100vh - 56px);
  gap: 0;
}

#top-row {
  display: grid;
  grid-template-columns: 58% 42%;
  gap: 0;
  min-height: 0;
  overflow: hidden;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   PANEL SHARED STYLES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
.panel {
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

.panel-header {
  background: linear-gradient(90deg, var(--navy-dark), var(--navy-mid));
  border-bottom: 2px solid var(--gold);
  padding: 5px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.panel-title {
  font-family: 'Oswald', sans-serif;
  font-size: 12px; font-weight: 600;
  letter-spacing: 3px; text-transform: uppercase;
  color: var(--gold-light);
}
.panel-meta {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px; color: var(--muted);
}

.panel-body {
  flex: 1;
  overflow: hidden;
  position: relative;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   RADAR PANEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#panel-radar { border-left: none; }

#radarMap {
  width: 100%;
  height: 100%;
  background: #020810;
}

/* Leaflet overrides */
.leaflet-container { background: #020810 !important; }
.leaflet-control-zoom a {
  background: var(--navy-mid) !important;
  color: var(--gold) !important;
  border-color: var(--border) !important;
}
.leaflet-control-attribution {
  background: rgba(0,20,50,0.7) !important;
  color: var(--muted) !important;
  font-size: 9px !important;
}

.radar-timestamp {
  position: absolute;
  bottom: 8px; left: 8px;
  background: rgba(0,20,60,0.85);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 3px 8px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px; color: var(--gold-light);
  z-index: 1000;
  pointer-events: none;
}

.radar-legend {
  position: absolute;
  top: 8px; right: 8px;
  background: rgba(0,20,60,0.85);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 6px 8px;
  z-index: 1000;
  pointer-events: none;
}
.radar-legend-title {
  font-family: 'Oswald', sans-serif;
  font-size: 9px; letter-spacing: 2px;
  text-transform: uppercase; color: var(--muted);
  margin-bottom: 4px;
}
.radar-legend-bar {
  display: flex;
  height: 8px;
  width: 120px;
  border-radius: 1px;
  overflow: hidden;
}
.radar-legend-bar div { flex: 1; }
.radar-legend-labels {
  display: flex;
  justify-content: space-between;
  font-family: 'Share Tech Mono', monospace;
  font-size: 8px; color: var(--muted);
  margin-top: 2px;
}

/* Margate location marker */
.margate-marker {
  background: none; border: none;
}
.margate-dot {
  width: 12px; height: 12px;
  background: var(--gold);
  border: 2px solid #fff;
  border-radius: 50%;
  box-shadow: 0 0 8px var(--gold), 0 0 16px rgba(200,151,58,0.4);
  animation: margatePulse 2s infinite;
}
@keyframes margatePulse {
  0%,100% { box-shadow: 0 0 6px var(--gold), 0 0 12px rgba(200,151,58,0.4); }
  50%      { box-shadow: 0 0 14px var(--gold), 0 0 28px rgba(200,151,58,0.6); }
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   RIGHT COLUMN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#right-col {
  display: grid;
  grid-template-rows: 40% 60%;
  border-right: none;
  overflow: hidden;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   FORECAST PANEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#forecast-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: 1fr;
  gap: 6px;
  padding: 8px;
  height: 100%;
  overflow: hidden;
  align-items: stretch;
}

.forecast-card {
  background: rgba(0,20,60,0.6);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 8px 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  position: relative;
  overflow: hidden;
}
.forecast-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}
.forecast-card.day::before   { background: var(--gold); }
.forecast-card.night::before { background: var(--sky); }

.fc-period {
  font-family: 'Oswald', sans-serif;
  font-size: 13px; font-weight: 600;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--gold-light);
  text-align: center;
}
.fc-icon { font-size: 38px; line-height: 1; }
.fc-temp {
  font-family: 'Oswald', sans-serif;
  font-size: 34px; font-weight: 700;
  color: var(--white); line-height: 1;
}
.fc-temp span {
  font-size: 17px; color: var(--muted); font-weight: 400;
}
.fc-short {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 14px; font-weight: 600;
  color: var(--off-white);
  text-align: center; line-height: 1.3;
}
.fc-wind {
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px; color: var(--muted);
  text-align: center;
}
.fc-precip {
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px; color: var(--sky);
}
.fc-loading {
  grid-column: 1/-1;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted);
  font-family: 'Oswald', sans-serif;
  font-size: 13px; letter-spacing: 2px; text-transform: uppercase;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   OBSERVATION PANEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#obs-grid {
  padding: 8px 10px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto 1fr auto;
  gap: 6px;
  height: 100%;
  overflow: hidden;
}

.obs-hero {
  grid-column: 1/-1;
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(0,20,60,0.5);
  border: 1px solid var(--border);
  border-left: 3px solid var(--gold);
  border-radius: 3px;
  padding: 6px 10px;
}
.obs-hero-icon { font-size: 32px; line-height: 1; }
.obs-hero-temp {
  font-family: 'Oswald', sans-serif;
  font-size: 38px; font-weight: 700;
  color: var(--white); line-height: 1;
}
.obs-hero-temp span { font-size: 18px; color: var(--muted); font-weight: 400; }
.obs-hero-desc {
  flex: 1;
}
.obs-hero-sky {
  font-family: 'Oswald', sans-serif;
  font-size: 17px; font-weight: 600;
  color: var(--off-white); text-transform: uppercase; letter-spacing: 1px;
}
.obs-hero-feel {
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px; color: var(--muted);
}
.obs-flight {
  font-family: 'Oswald', sans-serif;
  font-size: 12px; font-weight: 700;
  letter-spacing: 2px; padding: 2px 8px;
  border-radius: 2px; text-transform: uppercase;
}
.obs-flight.VFR  { background: rgba(34,170,85,0.25); color: #44DD88; border: 1px solid #44DD88; }
.obs-flight.MVFR { background: rgba(34,136,221,0.25); color: #66AAFF; border: 1px solid #66AAFF; }
.obs-flight.IFR  { background: rgba(224,16,16,0.25);  color: #FF6666; border: 1px solid #FF6666; }
.obs-flight.LIFR { background: rgba(160,0,160,0.25);  color: #EE88FF; border: 1px solid #EE88FF; }

.obs-stat {
  background: rgba(0,20,60,0.5);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.obs-stat-label {
  font-family: 'Oswald', sans-serif;
  font-size: 12px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 4px;
}
.obs-stat-value {
  font-family: 'Share Tech Mono', monospace;
  font-size: 26px; color: var(--white); line-height: 1.1;
}
.obs-stat-sub {
  font-family: 'Oswald', sans-serif;
  font-size: 15px; color: var(--off-white); font-weight: 500;
}
.obs-stat-gust {
  font-family: 'Share Tech Mono', monospace;
  font-size: 18px; color: var(--gold-light);
}

/* Wind direction arrow */
.wind-arrow {
  display: inline-block;
  font-size: 14px;
  transition: transform .5s;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ALERTS TABLE (BOTTOM)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#bottom-row {
  border-top: 2px solid var(--gold);
  flex-shrink: 0;
  max-height: 220px;
  min-height: 100px;
  display: flex;
  flex-direction: column;
  background: var(--navy-dark);
}

#alerts-panel-header {
  background: linear-gradient(90deg, var(--navy-dark), var(--navy-mid));
  border-bottom: 1px solid var(--border);
  padding: 4px 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.alerts-title {
  font-family: 'Oswald', sans-serif;
  font-size: 12px; font-weight: 600;
  letter-spacing: 3px; text-transform: uppercase;
  color: var(--gold-light);
}
.alert-pill {
  font-family: 'Oswald', sans-serif;
  font-size: 10px; font-weight: 600;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 1px 8px; border-radius: 10px;
}
.pill-warning  { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning); }
.pill-watch    { background: var(--watch-bg);   color: var(--watch);   border: 1px solid var(--watch); }
.pill-advisory { background: var(--advisory-bg);color: var(--advisory);border: 1px solid var(--advisory); }
.pill-statement{ background:var(--statement-bg);color:var(--statement);border:1px solid var(--statement); }
.pill-special  { background: var(--special-bg); color: var(--special); border: 1px solid var(--special); }

#alerts-panel-header .spacer { flex: 1; }
#alerts-panel-header .meta {
  font-family: 'Share Tech Mono', monospace;
  font-size: 10px; color: var(--muted);
}

#alerts-scroll {
  flex: 1;
  overflow-x: auto;
  overflow-y: hidden;
  display: flex;
  align-items: stretch;
  gap: 6px;
  padding: 6px 10px;
}
#alerts-scroll::-webkit-scrollbar { height: 4px; }
#alerts-scroll::-webkit-scrollbar-track { background: var(--navy-dark); }
#alerts-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* Alert cycle indicator dots */
.alert-cycle-dots {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 0 10px;
  flex-shrink: 0;
}
.cycle-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--border);
  transition: background .3s;
}
.cycle-dot.active { background: var(--gold); }

/* Wide tile for cycling mode */
.alert-tile.wide {
  width: 100%;
  max-width: 600px;
}

.alert-tile {
  flex-shrink: 0;
  width: 280px;
  border-radius: 3px;
  border-left: 4px solid;
  padding: 7px 10px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  animation: tileIn .3s ease-out;
  position: relative;
  overflow: hidden;
}
@keyframes tileIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
.alert-tile.expiring { animation: tileOut .8s ease-in forwards; }
@keyframes tileOut { to { opacity:0; width:0; padding:0; margin:0; } }

.alert-tile.warning  { border-color:var(--warning);   background:var(--warning-bg); }
.alert-tile.watch    { border-color:var(--watch);     background:var(--watch-bg); }
.alert-tile.advisory { border-color:var(--advisory);  background:var(--advisory-bg); }
.alert-tile.statement{ border-color:var(--statement); background:var(--statement-bg); }
.alert-tile.special  { border-color:var(--special);   background:var(--special-bg); }

.tile-event {
  font-family: 'Oswald', sans-serif;
  font-size: 13px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .5px;
  color: var(--white); line-height: 1.1;
}
.alert-tile.warning .tile-event { color: #FF8888; }
.alert-tile.watch   .tile-event { color: var(--gold-light); }

.tile-issued {
  font-family: 'Share Tech Mono', monospace;
  font-size: 9px; color: var(--muted);
}
.tile-area {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 10px; color: var(--off-white);
  opacity: .8;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.tile-expires {
  font-family: 'Share Tech Mono', monospace;
  font-size: 9px;
}
.tile-bar {
  height: 2px; border-radius: 1px;
  background: rgba(255,255,255,0.1);
  margin-top: 2px; overflow: hidden;
}
.tile-bar-fill { height: 100%; border-radius: 1px; transition: width 60s linear; }
.alert-tile.warning  .tile-bar-fill { background: var(--warning); }
.alert-tile.watch    .tile-bar-fill { background: var(--watch); }
.alert-tile.advisory .tile-bar-fill { background: var(--advisory); }
.alert-tile.statement .tile-bar-fill { background: var(--statement); }
.alert-tile.special  .tile-bar-fill { background: var(--special); }

.no-alerts-tile {
  display: flex; align-items: center; gap: 10px;
  color: var(--muted);
  font-family: 'Oswald', sans-serif;
  font-size: 13px; letter-spacing: 2px; text-transform: uppercase;
  padding: 0 12px;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   TICKER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#ticker-bar {
  height: 28px;
  background: var(--navy-mid);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  overflow: hidden;
  flex-shrink: 0;
}
.ticker-label {
  background: var(--gold);
  color: var(--navy-dark);
  font-family: 'Oswald', sans-serif;
  font-size: 11px; font-weight: 700;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 0 12px; height: 100%;
  display: flex; align-items: center;
  flex-shrink: 0; white-space: nowrap;
}
.ticker-scroll {
  display: flex;
  white-space: nowrap;
}
.ticker-scroll:hover { animation-play-state: paused; }
.ticker-item {
  font-family: 'Oswald', sans-serif;
  font-size: 12px; font-weight: 500;
  letter-spacing: .5px; text-transform: uppercase;
  padding: 0 40px 0 0;
  display: flex; align-items: center; gap: 6px;
}
.ticker-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.ticker-item.warning  .ticker-dot { background:var(--warning); }
.ticker-item.watch    .ticker-dot { background:var(--watch); }
.ticker-item.advisory .ticker-dot { background:var(--advisory); }
.ticker-item.statement .ticker-dot { background:var(--statement); }
.ticker-item.special  .ticker-dot { background:var(--special); }
/* tickerMove keyframe generated dynamically by JS */

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   CITY SEAL SVG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* Rendered inline below */

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   MOBILE RESPONSIVE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
@media (max-width: 768px) {
  html, body { overflow: auto; }
  #dashboard { grid-template-rows: auto auto auto; height: auto; }
  #top-row   { grid-template-columns: 1fr; grid-template-rows: 280px auto auto; }
  #right-col { grid-template-rows: auto auto; }
  #panel-radar { height: 280px; }
  #bottom-row { max-height: none; }
  #alerts-scroll { flex-wrap: wrap; overflow-y: auto; height: auto; max-height: 300px; }
  .alert-tile { width: calc(50% - 6px); }
  #forecast-grid { grid-template-columns: repeat(3,1fr); }
  .header-center { display: none; }
  .city-name-block .city-name { font-size: 16px; }
  #ticker-bar { display: none; }
}
@media (max-width: 480px) {
  .alert-tile { width: 100%; }
  #forecast-grid { grid-template-columns: 1fr 1fr; }
  #obs-grid { grid-template-columns: 1fr; }
  .obs-hero { flex-wrap: wrap; }
}
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
</head>
<body>

<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     HEADER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div id="header">
  <div class="header-left">
    <div class="city-name-block">
      <div class="city-label">City of</div>
      <div class="city-name">Margate</div>
      <div class="city-sub">Broward County, Florida</div>
    </div>
  </div>

  <div class="header-center">
    <div class="dash-title">Weather Operations Dashboard</div>
    <div class="zone-tag">NWS Zone FLZ072 Â· MFL Office Â· KFXE Obs</div>
  </div>

  <div class="header-right">
    <div id="statusPip" class="status-pip loading"></div>
    <div class="clock-block">
      <div id="clock" class="clock-time">--:--:--</div>
      <div id="clockDate" class="clock-date">Loading...</div>
    </div>
  </div>
</div>

<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     DASHBOARD GRID
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div id="dashboard">
  <div id="top-row">

    <!-- RADAR PANEL -->
    <div class="panel" id="panel-radar">
      <div class="panel-header">
        <span class="panel-title">â¬¡ Live Radar â€” South Florida</span>
        <span class="panel-meta" id="radarMeta">Base Reflectivity Â· KAMX/KBYX Â· Animating</span>
      </div>
      <div class="panel-body">
        <div id="radarMap"></div>
        <div class="radar-timestamp" id="radarTimestamp">Loading radar...</div>
        <div class="radar-legend">
          <div class="radar-legend-title">dBZ</div>
          <div class="radar-legend-bar">
            <div style="background:#00ECEC"></div>
            <div style="background:#01A0F6"></div>
            <div style="background:#00FF00"></div>
            <div style="background:#00C800"></div>
            <div style="background:#FFFF00"></div>
            <div style="background:#E7C000"></div>
            <div style="background:#FF9000"></div>
            <div style="background:#FF0000"></div>
            <div style="background:#D60000"></div>
            <div style="background:#C000C0"></div>
          </div>
          <div class="radar-legend-labels">
            <span>5</span><span>35</span><span>65+</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div id="right-col">

      <!-- FORECAST PANEL -->
      <div class="panel" id="panel-forecast" style="overflow:hidden;">
        <div class="panel-header">
          <span class="panel-title">â˜€ Zone Forecast â€” FLZ072</span>
          <span class="panel-meta" id="fcMeta">Loading...</span>
        </div>
        <div class="panel-body" style="overflow:hidden;">
          <div id="forecast-grid" style="height:100%;">
            <div class="fc-loading">Loading forecast...</div>
          </div>
        </div>
      </div>

      <!-- OBSERVATION PANEL -->
      <div class="panel" id="panel-obs">
        <div class="panel-header">
          <span class="panel-title" id="obsTitle">ğŸ“¡ Latest Observation â€” KFXE</span>
          <span class="panel-meta" id="obsMeta">Fort Lauderdale Executive Airport</span>
        </div>
        <div class="panel-body">
          <div id="obs-grid">
            <div class="fc-loading" style="grid-column:1/-1">Loading observation...</div>
          </div>
        </div>
      </div>

    </div><!-- /right-col -->
  </div><!-- /top-row -->

  <!-- ALERTS BOTTOM ROW -->
  <div id="bottom-row">
    <div id="alerts-panel-header">
      <span class="alerts-title">âš  Active Alerts â€” Margate / FLZ072</span>
      <span id="alertPills"></span>
      <span class="spacer"></span>
      <span class="meta" id="alertsMeta">Loading...</span>
    </div>
    <div id="alerts-scroll">
      <div class="no-alerts-tile">Loading alerts...</div>
    </div>
  </div>

  <!-- TICKER -->
  <div id="ticker-bar">
    <div class="ticker-label">MRG WX</div>
    <div style="overflow:hidden;flex:1;">
      <div class="ticker-scroll" id="ticker"></div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  CONFIG
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const MARGATE_LAT  = 26.2459;
const MARGATE_LNG  = -80.2067;
const NWS_ALERTS   = 'https://api.weather.gov/alerts/active?status=actual&zone=FLZ072';
const NWS_FORECAST = 'https://api.weather.gov/gridpoints/MFL/110,37/forecast';
// Margate FL gridpoint: MFL office, grid 110,37
// Observation station fallback chain - tries each in order
// Falls back if station hasn't reported in 75 minutes
const OBS_STATIONS = [
  { id: 'KFXE', name: 'Fort Lauderdale Executive' },
  { id: 'KPMP', name: 'Pompano Beach Airpark' },
  { id: 'KFLL', name: 'Fort Lauderdale-Hollywood Intl' },
];
let activeObsStation = OBS_STATIONS[0];
let lastObsTime = null;
const NWS_HEADERS  = { 'User-Agent':'MargateWxDash/1.0 (margatefl.com)', 'Accept':'application/geo+json' };

const REFRESH_ALERTS   = 90_000;
const REFRESH_FORECAST = 900_000;  // 15 min
const REFRESH_OBS      = 300_000;  // 5 min
const REFRESH_RADAR    = 300_000;  // 5 min

let allAlerts    = [];
let knownIds     = new Set();
let expireTimers = new Map();
let firstLoad    = true;
let radarFrames  = [];
let radarIdx     = 0;
let radarLayer   = null;
let radarAnim    = null;
let map          = null;

// Fetch wrapper with hard timeout â€” prevents any hung request from stalling the page
async function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(timer);
    return res;
  } catch(e) {
    clearTimeout(timer);
    throw e; // Re-throw so callers can handle (AbortError = timeout)
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  CLOCK
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function updateClock() {
  const n = new Date();
  document.getElementById('clock').textContent =
    n.toLocaleTimeString('en-US', { hour12:false });
  document.getElementById('clockDate').textContent =
    n.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
}
setInterval(updateClock, 1000);
updateClock();

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  RADAR â€” RainViewer
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function initMap() {
  map = L.map('radarMap', {
    center: [MARGATE_LAT, MARGATE_LNG],
    zoom: 8,
    zoomControl: true,
    attributionControl: true,
  });

  // Base: CartoDB Positron No Labels â€” clean land/water/borders, no city clutter
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap Â© CARTO',
    subdomains: 'abcd',
    maxZoom: 14,
    zIndex: 1,
  }).addTo(map);

  // Dark tint so radar pops against light basemap
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
    attribution: '',
    subdomains: 'abcd',
    maxZoom: 14,
    zIndex: 3,
    opacity: 0.55,
  }).addTo(map);

  // Margate marker
  const margateDot = L.divIcon({
    className: 'margate-marker',
    html: '<div class="margate-dot"></div>',
    iconSize: [12,12], iconAnchor: [6,6],
  });
  L.marker([MARGATE_LAT, MARGATE_LNG], { icon: margateDot, zIndexOffset: 1000 })
    .addTo(map);

  // Load radar
  loadRadar();
}

// NWS Ridge2 radar â€” pure US government servers, no geo-blocking possible
// Uses api.weather.gov for scan timestamps + ridge2.weather.gov for tiles
// Same domain as all other dashboard data
let radarLayers = [];

async function loadRadar() {
  try {
    if (radarAnim) { clearInterval(radarAnim); radarAnim = null; }
    radarLayers.forEach(l => { try { map.removeLayer(l); } catch(e) {} });
    radarLayers = [];
    radarFrames = [];

    // Get available radar scans from NWS API â€” same domain as forecast/alerts
    const res = await fetchWithTimeout(
      'https://api.weather.gov/radar/stations/KAMX/scans?limit=12',
      { headers: NWS_HEADERS }, 10000
    );
    if (!res.ok) throw new Error('NWS radar API ' + res.status);
    const data = await res.json();

    const scans = (data['@graph'] || data.features || []).slice(-10);
    if (!scans.length) throw new Error('No scans returned');

    radarFrames = scans.map(s => {
      const timeStr = s.properties?.time || s.time || '';
      const dt = new Date(timeStr);
      // NWS ridge2 tile URL format
      // https://ridge2.weather.gov/api/mosaic-conus/{timestamp}/N0B/{z}/{x}/{y}
      const ts = encodeURIComponent(timeStr);
      return {
        dt,
        url: 'https://ridge2.weather.gov/api/station-reflectivity/KAMX/0.5/' + ts + '/{z}/{x}/{y}',
        label: dt.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true}),
      };
    });

    buildRadarLayers();

  } catch(e) {
    console.warn('NWS ridge2 failed, trying NWS WMS:', e.message);
    loadRadarWMS();
  }
}

// NWS GeoServer WMS fallback â€” single live image, no animation but guaranteed US
function loadRadarWMS() {
  try {
    if (radarAnim) { clearInterval(radarAnim); radarAnim = null; }
    radarLayers.forEach(l => { try { map.removeLayer(l); } catch(e) {} });
    radarLayers = [];

    // Single live radar mosaic â€” refreshes every 2 min
    const layer = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/conus/ows', {
      layers: 'conus_bref_qcd',
      format: 'image/png',
      transparent: true,
      version: '1.3.0',
      opacity: 0.75,
      zIndex: 20,
      attribution: 'Â© NOAA/NWS',
    });
    layer.addTo(map);
    radarLayers = [layer];
    radarFrames = [{ label: 'Live' }];

    const ts = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
    document.getElementById('radarTimestamp').textContent = 'Live Â· Updated ' + ts;
    document.getElementById('radarMeta').textContent = 'Base Reflectivity Â· NWS Live Â· No animation';

    // Refresh every 2 minutes
    radarAnim = setInterval(() => {
      map.removeLayer(layer);
      const newLayer = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/conus/ows', {
        layers: 'conus_bref_qcd',
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        opacity: 0.75,
        zIndex: 20,
        attribution: 'Â© NOAA/NWS',
      });
      newLayer.addTo(map);
      radarLayers = [newLayer];
      const t = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
      document.getElementById('radarTimestamp').textContent = 'Live Â· Updated ' + t;
    }, 120000);
  } catch(e) {
    document.getElementById('radarTimestamp').textContent = 'Radar unavailable';
  }
}

function buildRadarLayers() {
  radarFrames.forEach(frame => {
    const layer = L.tileLayer(frame.url, {
      opacity: 0, zIndex: 20, maxZoom: 14,
      attribution: 'Â© NOAA/NWS',
      errorTileUrl: '',
    });
    layer.addTo(map);
    radarLayers.push(layer);
  });

  radarIdx = 0;
  showRadarFrame(0);
  scheduleRadarAnim();

  document.getElementById('radarMeta').textContent =
    'Base Reflectivity Â· ' + radarFrames.length + ' frames Â· Auto-animating';
}

function scheduleRadarAnim() {
  if (radarAnim) clearInterval(radarAnim);
  radarAnim = setInterval(() => {
    const isLast = radarIdx === radarFrames.length - 1;
    setTimeout(() => {
      radarIdx = (radarIdx + 1) % radarFrames.length;
      showRadarFrame(radarIdx);
    }, isLast ? 2500 : 0);
  }, 900);
}

function showRadarFrame(idx) {
  if (!radarFrames[idx] || !radarLayers[idx]) return;
  radarLayers.forEach((layer, i) => layer.setOpacity(i === idx ? 0.75 : 0));
  const frame = radarFrames[idx];
  document.getElementById('radarTimestamp').textContent =
    'Frame ' + (idx+1) + '/' + radarFrames.length + ' Â· ' + frame.label;
}
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  WEATHER CONDITIONS â†’ ICON + COLOR
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function wxIcon(shortForecast, isDaytime) {
  const f = (shortForecast || '').toLowerCase();
  if (f.includes('tornado'))             return 'ğŸŒª';
  if (f.includes('thunder') || f.includes('t-storm')) return 'â›ˆ';
  if (f.includes('hurricane') || f.includes('tropical')) return 'ğŸŒ€';
  if (f.includes('snow') || f.includes('blizzard'))  return 'â„';
  if (f.includes('sleet') || f.includes('ice'))      return 'ğŸŒ¨';
  if (f.includes('freezing rain'))       return 'ğŸŒ§';
  if (f.includes('fog') || f.includes('mist'))       return 'ğŸŒ«';
  if (f.includes('rain') || f.includes('shower'))    return 'ğŸŒ§';
  if (f.includes('drizzle'))             return 'ğŸŒ¦';
  if (f.includes('partly cloudy') || f.includes('partly sunny')) return isDaytime ? 'â›…' : 'ğŸŒ¤';
  if (f.includes('mostly cloudy') || f.includes('mostly sunny')) return 'ğŸŒ¥';
  if (f.includes('cloudy') || f.includes('overcast')) return 'â˜';
  if (f.includes('wind') || f.includes('breezy') || f.includes('blustery')) return isDaytime ? 'ğŸŒ¬' : 'ğŸ’¨';
  if (f.includes('hazy') || f.includes('smoke'))     return 'ğŸ˜¶â€ğŸŒ«ï¸';
  if (f.includes('clear') || f.includes('sunny'))    return isDaytime ? 'â˜€' : 'ğŸŒ™';
  return isDaytime ? 'ğŸŒ¤' : 'ğŸŒ™';
}

function tempColor(tempF) {
  if (tempF >= 95) return '#FF4444';
  if (tempF >= 85) return '#FF8844';
  if (tempF >= 75) return '#FFD044';
  if (tempF >= 65) return '#88DDFF';
  if (tempF >= 50) return '#44BBFF';
  return '#88AAFF';
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  FETCH FORECAST
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
async function fetchForecast() {
  // Hardcoded fallback URL â€” works even if /points/ API call fails or times out
  // MFL grid 110,37 = Margate FL (verified)
  const FALLBACK_URL = 'https://api.weather.gov/gridpoints/MFL/110,37/forecast';
  try {
    // Try to resolve exact gridpoint URL (10s timeout)
    if (!window._forecastUrl) {
      try {
        const pointRes = await fetchWithTimeout(
          `https://api.weather.gov/points/${MARGATE_LAT},${MARGATE_LNG}`,
          { headers: NWS_HEADERS }, 10000
        );
        if (pointRes.ok) {
          const pointData = await pointRes.json();
          window._forecastUrl = pointData.properties?.forecast || FALLBACK_URL;
        } else {
          window._forecastUrl = FALLBACK_URL;
        }
      } catch(e) {
        // /points/ timed out or failed â€” use hardcoded fallback immediately
        console.warn('Points API failed, using hardcoded grid:', e.message);
        window._forecastUrl = FALLBACK_URL;
      }
    }

    const res = await fetchWithTimeout(window._forecastUrl, { headers: NWS_HEADERS }, 10000);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const periods = (data.properties && data.properties.periods) || [];
    if (!periods.length) throw new Error('No periods returned');
    renderForecast(periods);
    document.getElementById('fcMeta').textContent =
      'Updated ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
  } catch(e) {
    document.getElementById('forecast-grid').innerHTML =
      '<div class="fc-loading">Forecast unavailable â€” ' + e.message + '</div>';
    document.getElementById('fcMeta').textContent = 'Error';
    console.error('Forecast error:', e);
  }
}

function renderForecast(periods) {
  const grid = document.getElementById('forecast-grid');
  // Take up to 6 periods (3 days/nights)
  const shown = periods.slice(0, 3); // 3 periods â€” Today/Tonight/Tomorrow
  if (!shown.length) {
    grid.innerHTML = '<div class="fc-loading">No forecast data</div>';
    return;
  }

  grid.innerHTML = shown.map(p => {
    const icon    = wxIcon(p.shortForecast, p.isDaytime);
    const temp    = p.temperature || '--';
    const unit    = p.temperatureUnit || 'F';
    const tColor  = typeof temp === 'number' ? tempColor(temp) : '#fff';
    const wind    = p.windSpeed ? `${p.windDirection || ''} ${p.windSpeed}` : '';
    const name    = p.name || '';
    const isNight = !p.isDaytime;
    // extract precip chance if present in detailedForecast
    const precipMatch = (p.detailedForecast||'').match(/(\d+)\s*percent/i);
    const precip = precipMatch ? precipMatch[1] + '% precip' : '';

    return `
      <div class="forecast-card ${isNight ? 'night' : 'day'}">
        <div class="fc-period">${escHtml(name)}</div>
        <div class="fc-icon">${icon}</div>
        <div class="fc-temp" style="color:${tColor}">${temp}<span>Â°${unit}</span></div>
        <div class="fc-short">${escHtml(p.shortForecast || '')}</div>
        ${wind ? `<div class="fc-wind">ğŸ’¨ ${escHtml(wind)}</div>` : ''}
        ${precip ? `<div class="fc-precip">ğŸ’§ ${precip}</div>` : ''}
      </div>
    `;
  }).join('');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  FETCH OBSERVATION
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Fetch raw METAR â€” hard 4s timeout, never blocks page on network restrictions
async function fetchRawMetar(stationId) {
  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 4000);
    const res = await fetch(
      `https://aviationweather.gov/api/data/metar?ids=${stationId}&format=raw&hours=2`,
      { signal: controller.signal }
    );
    clearTimeout(timer);
    if (!res.ok) return null;
    const text = await res.text();
    const lines = text.trim().split('\n').filter(l => l.trim().length > 0);
    return lines[0] || null;
  } catch(e) {
    return null; // Timeout, CORS block, or network error â€” silent fallback
  }
}

// Parse temp/dew from METAR body group: 13/M04  22/18  M02/M05
function parseMetarTempDew(metar) {
  if (!metar) return { tempC: null, dewC: null };
  const m = metar.match(/\b(M?\d{2})\/(M?\d{2})\b/);
  if (!m) return { tempC: null, dewC: null };
  const pv = s => s.startsWith('M') ? -parseInt(s.slice(1)) : parseInt(s);
  return { tempC: pv(m[1]), dewC: pv(m[2]) };
}

// Magnus formula: RH% from temp + dew (Â°C)
function calcRelativeHumidity(tempC, dewC) {
  if (tempC == null || dewC == null) return null;
  const rh = 100 * Math.exp((17.625 * dewC) / (243.04 + dewC))
                 / Math.exp((17.625 * tempC) / (243.04 + tempC));
  return Math.round(Math.min(100, Math.max(0, rh)));
}

// NWS wind chill / heat index
function calcFeelsLike(tempF, dewF, windMph) {
  if (tempF == null) return null;
  if (tempF <= 50 && windMph != null && windMph >= 3) {
    return Math.round(35.74 + 0.6215*tempF - 35.75*Math.pow(windMph,0.16)
                    + 0.4275*tempF*Math.pow(windMph,0.16));
  }
  if (tempF >= 80 && dewF != null) {
    const R = calcRelativeHumidity((tempF-32)*5/9, (dewF-32)*5/9) ?? 50;
    const T = tempF;
    return Math.round(-42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R
                      - 0.00683783*T*T - 0.05481717*R*R + 0.00122874*T*T*R
                      + 0.00085282*T*R*R - 0.00000199*T*T*R*R);
  }
  return null;
}

function parseMetarWind(metar) {
  if (!metar) return { spd: null, gust: null, dir: null };
  // Match wind group: 29010G18KT or VRB05KT or 00000KT
  const m = metar.match(/\b(\d{3}|VRB)(\d{2,3})(?:G(\d{2,3}))?(KT|MPS|KMH)\b/i);
  if (!m) return { spd: null, gust: null, dir: null };
  const unit = m[4].toUpperCase();
  const toMph = unit === 'KT' ? 1.15078 : unit === 'MPS' ? 2.23694 : 0.62137;
  const dir  = m[1] === 'VRB' ? null : parseInt(m[1]);
  const spd  = Math.round(parseInt(m[2]) * toMph);
  const gust = m[3] ? Math.round(parseInt(m[3]) * toMph) : null;
  return { spd, gust, dir };
}

async function fetchObservation() {
  const STALE_MS = 75 * 60 * 1000;
  for (let i = 0; i < OBS_STATIONS.length; i++) {
    const station = OBS_STATIONS[i];
    try {
      const url = `https://api.weather.gov/stations/${station.id}/observations/latest`;
      const res = await fetchWithTimeout(url, { headers: NWS_HEADERS }, 10000);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const props = data.properties;

      const obsTime = props.timestamp ? new Date(props.timestamp) : null;
      const ageMs   = obsTime ? (Date.now() - obsTime) : Infinity;
      if (ageMs > STALE_MS) {
        console.warn(`${station.id} obs stale (${Math.round(ageMs/60000)} min) â€” trying next`);
        continue;
      }

      // Render immediately from NWS API â€” never wait on METAR fetch
      activeObsStation = station;
      lastObsTime = obsTime;
      renderObservation(props, station, null, null);
      document.getElementById('obsTitle').innerHTML =
        `ğŸ“¡ Latest Observation â€” ${station.id}` +
        (station.id !== 'KFXE' ? ' <span style="color:var(--gold-light);font-size:10px">(fallback)</span>' : '');
      document.getElementById('obsMeta').textContent =
        `${station.id} Â· ${station.name} Â· ` +
        (obsTime ? obsTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}) : '--');

      // METAR fetch runs in background â€” upgrades wind/gust/dew if accessible
      fetchRawMetar(station.id).then(rawMetar => {
        if (!rawMetar) return;
        renderObservation(props, station, parseMetarWind(rawMetar), rawMetar);
      });
      return;
    } catch(e) {
      console.warn(`${station.id} failed:`, e.message);
    }
  }
  document.getElementById('obs-grid').innerHTML =
    '<div class="fc-loading" style="grid-column:1/-1">All observation stations unavailable</div>';
}

function cToF(c) { return c == null ? null : Math.round(c * 9/5 + 32); }

// NWS observation API returns wind in km/h (wmoUnit:km_h-1)
// Check unitCode and convert accordingly
function windToMph(val, unitCode) {
  if (val == null) return null;
  const u = (unitCode || '').toLowerCase();
  if (u.includes('km_h') || u.includes('km/h'))  return Math.round(val * 0.6214);  // km/h â†’ mph
  if (u.includes('knot') || u.includes('[kn_i]')) return Math.round(val * 1.15078); // knots â†’ mph
  if (u.includes('m_s')  || u.includes('m/s'))    return Math.round(val * 2.23694); // m/s â†’ mph
  // Default: NWS typically sends km/h for ASOS stations
  return Math.round(val * 0.6214);
}

function paToInHg(pa) { return pa == null ? null : (pa / 3386.389).toFixed(2); }
function mToMi(m)  { return m == null ? null : (m / 1609.34).toFixed(1); }

function windDirArrow(deg) {
  if (deg == null) return '';
  // Arrow points the direction wind is COMING FROM
  return `<span class="wind-arrow" style="display:inline-block;transform:rotate(${deg}deg)">â†‘</span>`;
}

function flightCategory(vis, ceil) {
  // vis in meters, ceil in meters
  const visMi  = vis  ? vis / 1609.34  : 999;
  const ceilFt = ceil ? ceil * 3.28084 : 99999;
  if (visMi < 1    || ceilFt < 500)   return 'LIFR';
  if (visMi < 3    || ceilFt < 1000)  return 'IFR';
  if (visMi < 5    || ceilFt < 3000)  return 'MVFR';
  return 'VFR';
}

function renderObservation(p, station, metarWind, rawMetar) {
  // Temp/dew: use METAR group (13/M04) as fallback when API returns null
  const metarTD = parseMetarTempDew(rawMetar);
  const tempC   = p.temperature?.value ?? metarTD.tempC;
  const dewC    = p.dewpoint?.value    ?? metarTD.dewC;
  const tempF   = cToF(tempC);
  const dewF    = cToF(dewC);

  // Humidity: API first, then calculate from temp+dew
  const humid = p.relativeHumidity?.value
    ? Math.round(p.relativeHumidity.value)
    : calcRelativeHumidity(tempC, dewC);

  // Wind: METAR primary (correct unit), NWS API fallback
  let windSpd, windGust;
  if (metarWind?.spd != null) {
    windSpd  = metarWind.spd;
    windGust = metarWind.gust;
  } else {
    windSpd  = windToMph(p.windSpeed?.value,  p.windSpeed?.unitCode);
    windGust = windToMph(p.windGust?.value,   p.windGust?.unitCode);
  }
  const windDir         = metarWind?.dir != null ? metarWind.dir : p.windDirection?.value;
  const windDirCardinal = windDir != null ? degToCardinal(windDir) : '';

  // Feels-like: API first, then NWS formula
  const feelsF = p.heatIndex?.value  != null ? cToF(p.heatIndex.value)
               : p.windChill?.value  != null ? cToF(p.windChill.value)
               : calcFeelsLike(tempF, dewF, windSpd);

  const pressInHg = paToInHg(p.altimeterSetting?.value || p.barometricPressure?.value);
  const visMi     = mToMi(p.visibility?.value);
  const sky       = p.textDescription || 'Unknown';
  const ceilLayer = (p.cloudLayers||[]).find(l => ['BKN','OVC'].includes(l.amount));
  const ceilFt    = ceilLayer ? Math.round(ceilLayer.base.value * 3.28084) : null;
  const flCat     = flightCategory(p.visibility?.value, ceilLayer?.base?.value);
  const icon      = wxIcon(sky, true);
  const tColor    = tempF != null ? tempColor(tempF) : '#fff';

  // Decoded remarks block (only shown when raw METAR is available)
  const remarksHTML = buildRemarksHTML(rawMetar);

  document.getElementById('obs-grid').innerHTML = `
    <div class="obs-hero">
      <div class="obs-hero-icon">${icon}</div>
      <div class="obs-hero-temp" style="color:${tColor}">${tempF ?? '--'}<span>Â°F</span></div>
      <div class="obs-hero-desc">
        <div class="obs-hero-sky">${escHtml(sky)}</div>
        <div class="obs-hero-feel">${feelsF != null ? `Feels like ${feelsF}Â°F` : dewF != null ? `Dew ${dewF}Â°F` : ''}</div>
      </div>
      <div class="obs-flight ${flCat}">${flCat}</div>
    </div>

    <div class="obs-stat">
      <div class="obs-stat-label">Wind</div>
      <div class="obs-stat-value">${windDirCardinal} ${windDir != null ? windDirArrow(windDir) : ''} ${windSpd ?? '--'} mph</div>
      ${windGust
        ? `<div class="obs-stat-gust">Gusts ${windGust} mph</div>`
        : `<div class="obs-stat-sub">No gusts reported</div>`}
    </div>

    <div class="obs-stat">
      <div class="obs-stat-label">Humidity</div>
      <div class="obs-stat-value">${humid != null ? humid+'%' : '--%'}</div>
      <div class="obs-stat-sub">Dew ${dewF != null ? dewF+'Â°F' : '--Â°F'}</div>
    </div>

    <div class="obs-stat">
      <div class="obs-stat-label">Pressure</div>
      <div class="obs-stat-value">${pressInHg ?? '--'}"</div>
      <div class="obs-stat-sub">Altimeter</div>
    </div>

    <div class="obs-stat">
      <div class="obs-stat-label">Visibility</div>
      <div class="obs-stat-value">${visMi ?? '--'} mi</div>
      ${ceilFt ? `<div class="obs-stat-sub">Ceiling ${ceilFt.toLocaleString()} ft</div>` : '<div class="obs-stat-sub">Clear</div>'}
    </div>
    ${remarksHTML}
  `;
}

// Decoded METAR remarks â€” empty string if no rawMetar or no RMK section
function buildRemarksHTML(metar) {
  if (!metar) return '';
  const ri = metar.indexOf(' RMK ');
  if (ri === -1) return '';
  const rmk = metar.slice(ri + 5).trim();
  const items = [];

  if (/\bAO2\b/.test(rmk))      items.push(['Station',        'Auto w/ precip discriminator']);
  else if (/\bAO1\b/.test(rmk)) items.push(['Station',        'Auto (no precip discriminator)']);

  const slp = rmk.match(/\bSLP(\d{3})\b/);
  if (slp) {
    const v = parseInt(slp[1]);
    items.push(['Sea Level Pres', ((v >= 550 ? 900 : 1000) + v/10).toFixed(1) + ' hPa']);
  }

  const tg = rmk.match(/\bT(0|1)(\d{3})(0|1)(\d{3})\b/);
  if (tg) {
    const tC = (tg[1]==='1'?-1:1)*parseInt(tg[2])/10;
    const dC = (tg[3]==='1'?-1:1)*parseInt(tg[4])/10;
    items.push(['Precise Temp', cToF(tC)+'\u00b0F ('+tC.toFixed(1)+'\u00b0C)']);
    items.push(['Precise Dew',  cToF(dC)+'\u00b0F ('+dC.toFixed(1)+'\u00b0C)']);
  }

  const pt = rmk.match(/\b5(\d)(\d{3})\b/);
  if (pt) {
    const chars = ['Inc/Dec','Increasing','Inc/Steady','Inc Steady','Unsteady Inc',
                   'Dec/Inc','Decreasing','Dec/Steady','Dec Steady'];
    items.push(['3hr Pres', (chars[+pt[1]]||'?')+', '+(parseInt(pt[2])/10)+' hPa']);
  }

  if (/\$/.test(rmk)) items.push(['Maint', 'Station needs service']);

  if (!items.length) return '';

  // Build HTML using string concatenation to avoid template literal escaping issues
  var rows = items.map(function(item) {
    return '<span style="font-family:Share Tech Mono,monospace;font-size:11px;">'
         + '<span style="color:var(--muted);font-size:10px;">' + escHtml(item[0]) + ':</span> '
         + escHtml(item[1]) + '</span>';
  }).join('');

  return '<div style="grid-column:1/-1;background:rgba(0,20,60,0.5);border:1px solid var(--border);'
       + 'border-left:3px solid var(--muted);border-radius:3px;padding:5px 10px;">'
       + '<div style="font-family:Oswald,sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;'
       + 'text-transform:uppercase;color:var(--muted);margin-bottom:3px;">&#128203; Remarks</div>'
       + '<div style="display:flex;flex-wrap:wrap;gap:3px 14px;">' + rows + '</div>'
       + '<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--muted);'
       + 'margin-top:2px;word-break:break-all;">' + escHtml(metar) + '</div>'
       + '</div>';
}

function degToCardinal(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  SEVERITY HELPERS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getSevClass(event) {
  const e = (event||'').toLowerCase();
  if (e.includes(' warning'))  return 'warning';
  if (e.includes('watch'))     return 'watch';
  if (e.includes('special weather') || e.includes('urgent')) return 'special';
  if (e.includes('advisory'))  return 'advisory';
  return 'statement';
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  POLYGON CHECK â€” point in polygon
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function pointInPolygon(lat, lng, polygon) {
  // polygon is array of [lng, lat] pairs (GeoJSON order)
  let inside = false;
  const x = lng, y = lat;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
      inside = !inside;
    }
  }
  return inside;
}

function alertAffectsMargate(feature) {
  const geom = feature.geometry;
  if (!geom) return true; // zone-based, already filtered by API
  if (geom.type === 'Polygon') {
    return pointInPolygon(MARGATE_LAT, MARGATE_LNG, geom.coordinates[0]);
  }
  if (geom.type === 'MultiPolygon') {
    return geom.coordinates.some(poly => pointInPolygon(MARGATE_LAT, MARGATE_LNG, poly[0]));
  }
  return true;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  FETCH ALERTS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
async function fetchAlerts() {
  setStatus('loading');
  try {
    const res  = await fetchWithTimeout(NWS_ALERTS, { headers: NWS_HEADERS }, 10000);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    processAlerts(data.features || []);
    setStatus('ok');
  } catch(e) {
    console.error('Alerts error:', e);
    setStatus('error');
    if (firstLoad) {
      document.getElementById('alerts-scroll').innerHTML =
        '<div class="no-alerts-tile">Alerts unavailable â€” ' + e.message + '</div>';
    }
  }
  firstLoad = false;
}

function setStatus(s) {
  const pip = document.getElementById('statusPip');
  pip.className = 'status-pip' + (s==='ok'?'': s==='loading'?' loading':' error');
}

function processAlerts(features) {
  const now = new Date();
  const fresh = [];
  const freshIds = new Set();

  features.forEach(f => {
    const props   = f.properties;
    const expires = props.expires ? new Date(props.expires) : null;
    if (expires && expires < now) return;
    if (!alertAffectsMargate(f)) return;

    const id      = props.id || f.id;
    freshIds.add(id);
    const sent    = props.sent      ? new Date(props.sent)
                  : props.effective ? new Date(props.effective)
                  : now;

    fresh.push({
      id, sent, expires,
      event:    props.event || '',
      areas:    props.areaDesc || '',
      onset:    props.onset ? new Date(props.onset) : sent,
      sender:   props.senderName || 'NWS MFL',
      sevClass: getSevClass(props.event),
      isNew:    !knownIds.has(id),
      remark:   extractRemark(props.description || ''),
    });
  });

  const brandNew = fresh.filter(a => a.isNew);
  if (!firstLoad && brandNew.length > 0) flashNewAlert(brandNew);

  knownIds  = freshIds;
  allAlerts = fresh.sort((a,b) => b.sent - a.sent);

  renderAlerts();
  renderTicker();
  updateAlertPills();

  document.getElementById('alertsMeta').textContent =
    `${allAlerts.length} Active Â· Updated ${new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
}

function flashNewAlert(items) {
  // Brief gold flash on header border
  const hdr = document.getElementById('header');
  hdr.style.borderBottomColor = '#FF4444';
  setTimeout(() => hdr.style.borderBottomColor = 'var(--gold)', 2000);
}

let alertCycleTimer = null;
let alertCycleIdx   = 0;

function renderAlerts() {
  const scroll = document.getElementById('alerts-scroll');
  expireTimers.forEach(t => clearTimeout(t));
  expireTimers.clear();
  if (alertCycleTimer) { clearInterval(alertCycleTimer); alertCycleTimer = null; }

  if (!allAlerts.length) {
    scroll.innerHTML = '<div class="no-alerts-tile">â˜€ No Active Alerts for Margate / FLZ072</div>';
    return;
  }

  // â‰¤4 alerts: show all as tiles side by side
  if (allAlerts.length <= 4) {
    scroll.innerHTML = '';
    allAlerts.forEach(a => {
      const tile = buildTile(a);
      scroll.appendChild(tile);
      scheduleExpire(a, tile);
    });
    return;
  }

  // >4 alerts: auto-cycle through them with dot indicators
  alertCycleIdx = 0;
  renderCycledAlert(scroll);
  alertCycleTimer = setInterval(() => {
    alertCycleIdx = (alertCycleIdx + 1) % allAlerts.length;
    renderCycledAlert(scroll);
  }, 8000); // rotate every 8 seconds
}

function renderCycledAlert(scroll) {
  const a = allAlerts[alertCycleIdx];
  if (!a) return;

  // Build tile
  const tile = buildTile(a);
  tile.classList.add('wide');
  tile.style.animation = 'tileIn .4s ease-out';

  // Build dot indicators
  const dotsHTML = allAlerts.map((al, i) =>
    `<div class="cycle-dot ${i === alertCycleIdx ? 'active' : ''}" title="${escHtml(al.event)}"></div>`
  ).join('');

  scroll.innerHTML = '';
  scroll.appendChild(tile);

  // Add cycle info
  const info = document.createElement('div');
  info.style.cssText = 'display:flex;flex-direction:column;justify-content:center;gap:6px;padding:0 8px;flex-shrink:0;';
  info.innerHTML = `
    <div style="font-family:'Oswald',sans-serif;font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;">${alertCycleIdx+1} / ${allAlerts.length}</div>
    <div class="alert-cycle-dots">${dotsHTML}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);">Auto-cycling 8s</div>
  `;
  scroll.appendChild(info);
}

function buildTile(a) {
  const tile = document.createElement('div');
  tile.className = `alert-tile ${a.sevClass}`;
  tile.dataset.id = a.id;

  let pct = 100, expStr = '', expClass = '';
  if (a.expires) {
    const minsLeft  = Math.round((a.expires - Date.now()) / 60000);
    const totalMins = Math.max(1, Math.round((a.expires - a.onset) / 60000));
    pct = Math.max(0, Math.min(100, (minsLeft/totalMins)*100));
    expClass = minsLeft < 30 ? 'color:var(--warning)' : minsLeft < 90 ? 'color:var(--watch)' : 'color:var(--muted)';
    expStr = `Exp ${a.expires.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${a.expires.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
  }

  const area1 = a.areas.split(';')[0].trim();

  tile.innerHTML = `
    <div class="tile-event">${escHtml(a.event)}</div>
    <div class="tile-issued">Issued: ${a.sent.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${a.sent.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}</div>
    <div class="tile-area">${escHtml(area1)}</div>
    <div class="tile-expires" style="${expClass}">${expStr}</div>
    <div class="tile-bar"><div class="tile-bar-fill" style="width:${pct}%"></div></div>
  `;
  return tile;
}

function scheduleExpire(a, tile) {
  if (!a.expires) return;
  const ms = a.expires - Date.now();
  if (ms <= 0) { tile.remove(); return; }
  const t = setTimeout(() => {
    tile.classList.add('expiring');
    setTimeout(() => { tile.remove(); updateAlertPills(); }, 900);
  }, ms);
  expireTimers.set(a.id, t);
}

function updateAlertPills() {
  const counts = { warning:0, watch:0, advisory:0, statement:0, special:0 };
  allAlerts.forEach(a => { if (counts[a.sevClass] !== undefined) counts[a.sevClass]++; });
  const pills = document.getElementById('alertPills');
  pills.innerHTML = Object.entries(counts)
    .filter(([,n]) => n > 0)
    .map(([cls,n]) => `<span class="alert-pill pill-${cls}">${n} ${cls}${n>1?'s':''}</span>`)
    .join(' ');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  TICKER
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function renderTicker() {
  const ticker = document.getElementById('ticker');

  // Build single set of items
  const makeItems = (alerts) => alerts.map(a => `
    <div class="ticker-item ${a.sevClass}">
      <div class="ticker-dot"></div>
      ${escHtml(a.event)} &nbsp;Â·&nbsp;
      ${escHtml((a.areas.split(';')[0]||'').trim())}
      ${a.expires ? ` &nbsp;Â·&nbsp; Exp ${a.expires.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}` : ''}
      &nbsp;&nbsp;&nbsp;â¬¥&nbsp;&nbsp;&nbsp;
    </div>
  `).join('');

  if (!allAlerts.length) {
    ticker.innerHTML = '<div class="ticker-item" style="color:var(--muted);padding:0 30px">No active alerts for Margate / FLZ072 &nbsp;â˜€&nbsp;&nbsp;&nbsp;â¬¥&nbsp;&nbsp;&nbsp;No active alerts for Margate / FLZ072 &nbsp;â˜€&nbsp;&nbsp;&nbsp;â¬¥&nbsp;&nbsp;&nbsp;</div>';
    ticker.style.animation = 'none';
    // Use a simple looping animation for no-alert state
    startTickerAnim(ticker, 20);
    return;
  }

  // Render single set first, measure width, then duplicate enough to fill
  ticker.style.animation = 'none';
  ticker.innerHTML = makeItems(allAlerts);

  // After paint, measure and duplicate
  requestAnimationFrame(() => {
    const singleWidth = ticker.scrollWidth;
    const containerWidth = ticker.parentElement.offsetWidth;
    // Need enough copies to fill 2Ã— container width for seamless loop
    const copies = Math.max(2, Math.ceil((containerWidth * 2.5) / singleWidth));
    let html = '';
    for (let i = 0; i < copies; i++) html += makeItems(allAlerts);
    ticker.innerHTML = html;

    // Speed: ~80px/sec feels like broadcast TV crawl
    const totalWidth = singleWidth * copies;
    const halfWidth  = singleWidth * Math.floor(copies / 2);
    const speed      = 80; // px per second
    const duration   = (halfWidth / speed).toFixed(1);

    // Inject a unique keyframe for this run
    const styleId = 'tickerKF';
    let styleEl = document.getElementById(styleId);
    if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = styleId; document.head.appendChild(styleEl); }
    styleEl.textContent = `@keyframes tickerRun { 0%{transform:translateX(0)} 100%{transform:translateX(-${halfWidth}px)} }`;

    ticker.style.animation = `tickerRun ${duration}s linear infinite`;
  });
}

function startTickerAnim(ticker, seconds) {
  const styleId = 'tickerKF';
  let styleEl = document.getElementById(styleId);
  if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = styleId; document.head.appendChild(styleEl); }
  const w = ticker.scrollWidth / 2;
  styleEl.textContent = `@keyframes tickerRun { 0%{transform:translateX(0)} 100%{transform:translateX(-${w}px)} }`;
  ticker.style.animation = `tickerRun ${seconds}s linear infinite`;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  HELPERS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function extractRemark(desc) {
  const m = desc.match(/REMARKS?\.\.\.\s*(.+?)(?:\n\n|$)/is);
  if (m) return m[1].replace(/\n/g,' ').trim();
  return desc.slice(0,200).replace(/\n/g,' ').trim();
}
function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  COUNTDOWN BAR TICK
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
setInterval(() => {
  document.querySelectorAll('.alert-tile').forEach(tile => {
    const a = allAlerts.find(x => x.id === tile.dataset.id);
    if (!a || !a.expires) return;
    const minsLeft  = Math.round((a.expires - Date.now()) / 60000);
    const totalMins = Math.max(1, Math.round((a.expires - a.onset) / 60000));
    const pct = Math.max(0, Math.min(100, (minsLeft/totalMins)*100));
    const fill = tile.querySelector('.tile-bar-fill');
    if (fill) fill.style.width = pct + '%';
  });
}, 60_000);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  BOOT + AUTO-REFRESH
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
window.addEventListener('load', () => {
  // Init map first (synchronous DOM setup)
  initMap();

  // Fire all data fetches in parallel â€” one slow/blocked source won't delay others
  Promise.allSettled([
    fetchAlerts(),
    fetchForecast(),
    fetchObservation(),
  ]).then(() => {
    // All settled (resolved or rejected) â€” clear any remaining loading states
    const fcGrid = document.getElementById('forecast-grid');
    if (fcGrid.querySelector('.fc-loading')?.textContent === 'Loading forecast...') {
      fcGrid.innerHTML = '<div class="fc-loading">Forecast unavailable</div>';
    }
  });

  // Safety net: after 15s, replace any still-spinning loaders with error messages
  setTimeout(() => {
    const fcGrid = document.getElementById('forecast-grid');
    if (fcGrid.innerHTML.includes('Loading forecast')) {
      fcGrid.innerHTML = '<div class="fc-loading">Forecast unavailable â€” check network</div>';
    }
    const obsGrid = document.getElementById('obs-grid');
    if (obsGrid.innerHTML.includes('Loading observation')) {
      obsGrid.innerHTML = '<div class="fc-loading" style="grid-column:1/-1">Observation unavailable â€” check network</div>';
    }
    const scroll = document.getElementById('alerts-scroll');
    if (scroll.innerHTML.includes('Loading alerts')) {
      scroll.innerHTML = '<div class="no-alerts-tile">Alerts unavailable â€” check network</div>';
    }
  }, 15000);

  // Auto-refresh intervals
  setInterval(fetchAlerts,      REFRESH_ALERTS);
  setInterval(fetchForecast,    REFRESH_FORECAST);
  setInterval(fetchObservation, REFRESH_OBS);
  // Radar self-refreshes via its own internal timer
});
</script>
</body>
</html>
