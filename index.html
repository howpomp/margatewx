<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>City of Margate — Weather Operations Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #003087; --navy-dark: #001A4D; --navy-mid: #002060;
  --gold: #C8973A; --gold-light: #E8B84B; --white: #FFFFFF;
  --muted: #7A9AC0; --border: #0A3A7A;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; background: var(--navy-dark); color: var(--off-white); font-family: 'Source Sans 3', sans-serif; overflow: hidden; }
#header { height: 50px; background: linear-gradient(135deg, #001A4D 0%, #003087 100%); border-bottom: 2px solid var(--gold); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
.city-name { font-family: 'Oswald', sans-serif; font-size: 18px; font-weight: 700; text-transform: uppercase; color: var(--white); }
.clock-time { font-family: 'Share Tech Mono', monospace; font-size: 20px; color: var(--white); }
#dashboard { display: grid; grid-template-rows: 1fr auto; height: calc(100vh - 50px); }
#top-row { display: grid; grid-template-columns: 60% 40%; overflow: hidden; }
.panel { border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.panel-header { background: var(--navy-mid); border-bottom: 2px solid var(--gold); padding: 4px 10px; display: flex; justify-content: space-between; align-items: center; font-family: 'Oswald', sans-serif; font-size: 11px; text-transform: uppercase; color: var(--gold-light); }
#radarMap { width: 100%; height: 100%; background: #000; }
#right-col { display: grid; grid-template-rows: 35% 65%; }
#forecast-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 5px; height: 100%; }
.forecast-card { background: rgba(0,20,60,0.6); border: 1px solid var(--border); padding: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
#obs-grid { padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
.obs-hero { grid-column: 1/-1; background: rgba(0,20,60,0.5); border-left: 3px solid var(--gold); padding: 10px; display: flex; justify-content: space-between; align-items: center; }
.obs-hero-temp { font-family: 'Oswald', sans-serif; font-size: 34px; font-weight: 700; color: #FFF; }
.obs-stat { background: rgba(0,20,60,0.5); border: 1px solid var(--border); padding: 6px; }
.stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; margin-bottom: 2px; }
.stat-value { font-family: 'Share Tech Mono', monospace; font-size: 16px; color: #FFF; }
#bottom-row { border-top: 1px solid var(--gold); background: var(--navy-dark); padding: 5px 15px; font-size: 12px; height: 30px; display: flex; align-items: center; }
.status-pip { width: 8px; height: 8px; border-radius: 50%; background: #33DD66; margin-right: 10px; }
.margate-dot { width: 10px; height: 10px; background: var(--gold); border: 2px solid #fff; border-radius: 50%; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
</head>
<body>
<div id="header">
  <div class="city-name">Margate Weather Operations</div>
  <div style="display:flex; align-items:center;">
    <div id="statusPip" class="status-pip"></div>
    <div id="clock" class="clock-time">00:00:00</div>
  </div>
</div>
<div id="dashboard">
  <div id="top-row">
    <div class="panel">
      <div class="panel-header"><span>Live Radar (US-IEM)</span><span id="radarTime">--</span></div>
      <div id="radarMap"></div>
    </div>
    <div id="right-col">
      <div class="panel">
        <div class="panel-header"><span>3-Day Forecast</span></div>
        <div id="forecast-grid"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><span id="obsStation">Observation</span></div>
        <div id="obs-grid"></div>
      </div>
    </div>
  </div>
  <div id="bottom-row"><div id="alerts">Checking for active alerts...</div></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const LAT=26.2459, LNG=-80.2067;
const STATIONS = ['KFXE', 'KPMP', 'KFLL'];
const HEADERS = {'User-Agent': 'MargateDash/2.0'};
let map, radarLayer, radarIdx = 0;

function updateClock(){ document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', {hour12:false}); }
setInterval(updateClock, 1000);

function initMap(){
  map = L.map('radarMap', {center: [LAT, LNG], zoom: 9, zoomControl: false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  L.marker([LAT, LNG], {icon: L.divIcon({className: 'margate-dot'})}).addTo(map);
  updateRadar();
  setInterval(updateRadar, 300000);
}

function updateRadar(){
  const frames = [10, 5, 0];
  if(window.radarInterval) clearInterval(window.radarInterval);
  window.radarInterval = setInterval(() => {
    if(radarLayer) map.removeLayer(radarLayer);
    const offset = frames[radarIdx];
    const ts = Math.floor((Date.now() - offset * 60000) / 300000);
    radarLayer = L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?ts=${ts}`, {opacity: 0.7}).addTo(map);
    document.getElementById('radarTime').textContent = offset === 0 ? 'LIVE' : `-${offset}m`;
    radarIdx = (radarIdx + 1) % frames.length;
  }, 1500);
}

async function getForecast(){
  try {
    const pRes = await fetch(`https://api.weather.gov/points/${LAT},${LNG}`, {headers: HEADERS});
    const pData = await pRes.json();
    const fRes = await fetch(pData.properties.forecast, {headers: HEADERS});
    const fData = await fRes.json();
    const p = fData.properties.periods.slice(0, 3);
    document.getElementById('forecast-grid').innerHTML = p.map(day => `
      <div class="forecast-card">
        <div style="font-size:9px; color:var(--gold-light)">${day.name}</div>
        <div style="font-size:16px; font-weight:700">${day.temperature}°${day.temperatureUnit}</div>
        <div style="font-size:8px; text-align:center">${day.shortForecast}</div>
      </div>`).join('');
  } catch(e) { document.getElementById('forecast-grid').innerHTML = 'Forecast Unavailable'; }
}

async function getObs(){
  for(let id of STATIONS){
    try {
      const res = await fetch(`https://api.weather.gov/stations/${id}/observations/latest`, {headers: HEADERS});
      const d = await res.json();
      const p = d.properties;
      const temp = p.temperature.value ? Math.round(p.temperature.value * 9/5 + 32) : '--';
      const dew = p.dewpoint.value ? Math.round(p.dewpoint.value * 9/5 + 32) : '--';
      const humid = p.relativeHumidity.value ? Math.round(p.relativeHumidity.value) + '%' : 'N/A';
      const wind = p.windSpeed.value ? Math.round(p.windSpeed.value * 0.62) + ' MPH' : 'CALM';
      
      document.getElementById('obs-grid').innerHTML = `
        <div class="obs-hero"><div class="obs-hero-temp">${temp}°F</div>
