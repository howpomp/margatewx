<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>City of Margate — Weather Operations Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* Simplified core styles for performance */
:root {
  --navy: #003087; --navy-dark: #001A4D; --navy-mid: #002060; --navy-light: #0A3A7A;
  --gold: #C8973A; --gold-light: #E8B84B; --white: #FFFFFF; --off-white: #E8EEF8;
  --muted: #7A9AC0; --border: #0A3A7A;
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; background: var(--navy-dark); color: var(--off-white); font-family: 'Source Sans 3', sans-serif; overflow: hidden; }
#header { height: 56px; background: linear-gradient(135deg, #001A4D 0%, #003087 50%, #002060 100%); border-bottom: 3px solid var(--gold); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: relative; flex-shrink: 0; }
.city-name { font-family: 'Oswald', sans-serif; font-size: 22px; font-weight: 700; text-transform: uppercase; color: var(--white); }
.clock-time { font-family: 'Share Tech Mono', monospace; font-size: 22px; color: var(--white); }
#dashboard { display: grid; grid-template-rows: 1fr auto; height: calc(100vh - 56px); }
#top-row { display: grid; grid-template-columns: 58% 42%; overflow: hidden; }
.panel { border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.panel-header { background: var(--navy-mid); border-bottom: 2px solid var(--gold); padding: 5px 12px; display: flex; justify-content: space-between; align-items: center; }
.panel-title { font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--gold-light); }
#radarMap { width: 100%; height: 100%; background: #000; }
#right-col { display: grid; grid-template-rows: 40% 60%; }
#forecast-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 8px; height: 100%; }
.forecast-card { background: rgba(0,20,60,0.6); border: 1px solid var(--border); border-radius: 3px; padding: 8px 6px; display: flex; flex-direction: column; align-items: center; }
#obs-grid { padding: 8px 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.obs-hero { grid-column: 1/-1; background: rgba(0,20,60,0.5); border-left: 3px solid var(--gold); padding: 10px; }
.obs-hero-temp { font-family: 'Oswald', sans-serif; font-size: 38px; font-weight: 700; color: #FFF; }
.obs-stat { background: rgba(0,20,60,0.5); border: 1px solid var(--border); padding: 8px; }
#bottom-row { border-top: 2px solid var(--gold); min-height: 80px; background: var(--navy-dark); padding: 10px; }
.status-pip { width: 10px; height: 10px; border-radius: 50%; background: #33DD66; margin-right: 8px; display: inline-block; }
.status-pip.loading { background: var(--gold); }
.margate-dot { width: 12px; height: 12px; background: var(--gold); border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 8px var(--gold); }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
</head>
<body>
<div id="header">
  <div class="header-left"><div class="city-name">Margate Weather Ops</div></div>
  <div class="header-right">
    <div id="statusPip" class="status-pip loading"></div>
    <span id="clock" class="clock-time">--:--:--</span>
  </div>
</div>
<div id="dashboard">
  <div id="top-row">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Live Radar</span><span id="radarTimestamp" style="font-size:10px">Loading...</span></div>
      <div id="radarMap"></div>
    </div>
    <div id="right-col">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Forecast</span></div>
        <div id="forecast-grid"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title" id="obsTitle">Latest Observation</span></div>
        <div id="obs-grid"></div>
      </div>
    </div>
  </div>
  <div id="bottom-row"><div id="alerts-scroll">No Active Alerts</div></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const MARGATE_LAT=26.2459, MARGATE_LNG=-80.2067;
const NWS_HEADERS={'User-Agent':'MargateWxDash/1.0','Accept':'application/geo+json'};
const STATIONS = ['KFXE', 'KPMP', 'KFLL']; // Ordered as requested
let map, radarLayer, radarAnim, radarIdx=0;

function updateClock(){ document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false}); }
setInterval(updateClock,1000);

function initMap(){
  map=L.map('radarMap',{center:[MARGATE_LAT,MARGATE_LNG],zoom:9,zoomControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  L.marker([MARGATE_LAT,MARGATE_LNG],{icon:L.divIcon({className:'margate-dot',iconSize:[12,12]})}).addTo(map);
  loadRadar();
}

function loadRadar(){
  const frames=[{a:10,l:'-10m'},{a:5,l:'-5m'},{a:0,l:'Now'}];
  if(radarAnim) clearInterval(radarAnim);
  radarAnim=setInterval(()=>{
    radarIdx=(radarIdx+1)%frames.length;
    if(radarLayer) map.removeLayer(radarLayer);
    const ts=Math.floor((Date.now()-frames[radarIdx].a*60000)/300000);
    radarLayer=L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?ts=${ts}`,{opacity:0.75}).addTo(map);
    document.getElementById('radarTimestamp').textContent=frames[radarIdx].l;
  },1200);
}

async function fetchForecast(){
  try{
    const res=await fetch('https://api.weather.gov/gridpoints/MFL/110,37/forecast',{headers:NWS_HEADERS});
    const d=await res.json();
    const p=d.properties.periods.slice(0,3);
    document.getElementById('forecast-grid').innerHTML=p.map(x=>`
      <div class="forecast-card"><div style="font-size:10px">${x.name}</div><div style="font-size:18px;font-weight:700">${x.temperature}°${x.temperatureUnit}</div><div style="font-size:9px;text-align:center">${x.shortForecast}</div></div>`).join('');
  } catch(e){ document.getElementById('forecast-grid').innerHTML='Forecast Error'; }
}

async function fetchObs(){
  for(let id of STATIONS){
    try{
      const res=await fetch(`https://api.weather.gov/stations/${id}/observations/latest`,{headers:NWS_HEADERS});
      if(!res.ok) continue;
      const d=await res.json();
      const p=d.properties;
      const temp = p.temperature.value ? Math.round(p.temperature.value*9/5+32) : '--';
      const humid = p.relativeHumidity.value ? Math.round(p.relativeHumidity.value) : 'N/A';
      const wind = p.windSpeed.value ? Math.round(p.windSpeed.value*0.62) : 0;
      
      document.getElementById('obs-grid').innerHTML=`
        <div class="obs-hero"><div class="obs-hero-temp">${temp}°F</div><div style="font-size:14px">${p.textDescription}</div></div>
        <div class="obs-stat"><div style="font-size:10px">WIND</div><div style="font-size:18px">${wind} MPH</div></div>
        <div class="obs-stat"><div style="font-size:10px">HUMIDITY</div><div style="font-size:18px">${humid}%</div></div>`;
      document.getElementById('obsTitle').textContent=`Obs — ${id}`;
      return; 
    } catch(e) { console.warn(`Station ${id} failed`); }
  }
}

async function fetchAlerts(){
  try{
    const res=await fetch('https://api.weather.gov/alerts/active?zone=FLZ072',{headers:NWS_HEADERS});
    const d=await res.json();
    document.getElementById('statusPip').className='status-pip';
    if(d.features.length) document.getElementById('alerts-scroll').textContent = d.features[0].properties.headline;
  } catch(e){ document.getElementById('statusPip').className='status-pip loading'; }
}

window.onload=()=>{ initMap(); fetchForecast(); fetchObs(); fetchAlerts(); setInterval(fetchObs,300000); setInterval(fetchAlerts,120000); };
</script>
</body>
</html>
